{% extends "streetview/base.html" %}
{% load static %}
{% load app %}

{% block content %}
<script type="module">
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie("csrftoken");
    var prefnl;
    var predir = 0;

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });




    var scene, camera, renderer;
    var controls;
    var image_url = "./images/puydesancy.jpg";
    var sphere, cube;
    var clickTargets = [];
    var forwardButtonGroup = new THREE.Group();
    var relatedSceneId = [], relatedSceneTheta = [];

    class ForwardButton extends THREE.Mesh {
        constructor() {
            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshNormalMaterial();
            super(geometry, material);
        }
    }

    window.addEventListener("resize", function() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
    }, false);

    window.addEventListener("click", function(e) {
        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();

        if (e.target == renderer.domElement) {
            mouse.x = ( e.clientX / window.innerWidth ) * 2 - 1;
            mouse.y = - ( e.clientY / window.innerHeight ) * 2 + 1;

            raycaster.setFromCamera( mouse, camera );

            var obj = raycaster.intersectObjects( clickTargets );
            
            if ( obj.length > 0 ){
                $.ajax({
                    "url": "{% url 'streetview:ajax_transition' %}",
                    "type": "GET",
                    "data": {
                        "id": scene_id,
                    },
                    "dataType": "json",
                    "cache": false,
                }).done( r => {
                    image_url = r.scene_image_url;
                    relatedSceneId = r.related_scene_id;
                    relatedSceneTheta = r.related_scene_theta;

                    initWorld();
                });
            }
        }
    });

    window.addEventListener("load", function() {
        init();
        checkDevice();
        initWorld();
    });

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.1, 1000 );
        camera.position.set( 1.5, 0, 0 );
        scene.add( camera );

        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );            
        renderer.xr.enabled = true;
        
        document.body.appendChild( renderer.domElement );
    }

    function checkDevice(){
        if ("xr" in navigator) {
            navigator.xr.isSessionSupported("immersive-vr").then(function(supported) {
                if(supported) {
                    renderer.xr.enabled = true;
                } else {
                    setController();
                }
            })
        } else {
            setController();
        }
    }

    function setController() {
        document.addEventListener("touchmove", function(e) { e.preventDefault(); }, { passive:false });
        controls = new THREE.OrbitControls( camera, renderer.domElement );
        controls.target.set( 0, 0, 0 );
        controls.enableDamping = true;
        controls.dampingFactor = 0.5;
        controls.enableZoom = false;
    }

    function initWorld() {
        while(scene.children.length > 0){ 
            scene.remove( scene.children[0] ); 
        }

        const geometry = new THREE.SphereGeometry( 100, 100, 100 );
        geometry.scale( -1, 1, 1 );

        const texture = new THREE.TextureLoader().load( image_url );
        const material = new THREE.MeshBasicMaterial({
            map: texture
        });

        sphere = new THREE.Mesh( geometry, material );
        scene.add( sphere );

        initObjects();
    }

    function initObjects() {
        for (var i = 0; i < relatedSceneId.length; i++) {
            const mesh = new ForwardButton();

            const radian = relatedSceneTheta[i];
            mesh.position.set(
                8 * Math.cos(radian),
                3,
                8 * Math.sin(radian)
            );

            mesh.name = "forward_button_" + toString(i);
            clickTargets.push( mesh );

            forwardButtonGroup.add(mesh);
        }

        scene.add( forwardButtonGroup );

        rendering();
    }
    
    function rendering() {
        const animate = function() {
            if(controls){
                controls.update();
            }
            
            renderer.render( scene, camera );
            requestAnimationFrame( animate );
        };
        animate();
    }
</script>
{% endblock %}
